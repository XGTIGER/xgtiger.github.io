<!DOCTYPE html>
<html lang="en">
<head>
        <title>ansible 快速上手--loops</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />
        <link href="/" type="application/atom+xml" rel="alternate" title="XGTIGER's Notes ATOM Feed" />


        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie.css"/>
                <script src="/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="">XGTIGER's Notes </a></h1>
                <nav><ul>
                    <li ><a href="/category/ansible.html">Ansible</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
<section id="content" class="body">    
<article>
        <header> <h1 class="entry-title"><a href="ansible-kuai-su-shang-shou-loops.html"
        rel="bookmark" title="Permalink to ansible 快速上手--loops">ansible 快速上手--loops</a></h1>   </header>
        <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-04-13T13:50:00+08:00">
                一 13 四月 2015
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="/author/wyk.html">wyk</a>
        </address>
<p>In <a href="/category/ansible.html">Ansible</a>. </p>
</p>
</footer><!-- /.post-info -->        <p>Ansible提供了多种遍历操作功能,包括对特定文件等操作
* with_items标准循环</p>
<div class="highlight"><pre><span></span><span class="x">- name: add several users</span>
<span class="x">  user: name=</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> state=present groups=wheel</span>
<span class="x">  with_items:</span>
<span class="x">     - testuser1</span>
<span class="x">     - testuser2</span>
</pre></div>


<ul>
<li>笛卡尔积</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">- hosts: all</span>
<span class="x">  vars:</span>
<span class="x">    - list1: [1,2,3]</span>
<span class="x">    - list2: [4,5,6]</span>
<span class="x">    - list3: [7,8,9]</span>
<span class="x">  tasks:</span>
<span class="x">    - debug: msg=&quot;</span><span class="cp">{{</span><span class="nv">item</span><span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">      with_cartesian:</span>
<span class="x">        - list1</span>
<span class="x">        - list2</span>
<span class="x">        - list3</span>
</pre></div>


<ul>
<li>with_file</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">---</span>
<span class="x">- hosts: all</span>

<span class="x">  tasks:</span>

<span class="x">    # emit a debug message containing the content of each file.</span>
<span class="x">    - debug:</span>
<span class="x">        msg: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">      with_file:</span>
<span class="x">        - first_example_file</span>
<span class="x">        - second_example_file</span>
</pre></div>


<ul>
<li>with_dict</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">---</span>
<span class="x">users:</span>
<span class="x">  alice:</span>
<span class="x">    name: Alice Appleworth</span>
<span class="x">    telephone: 123-456-7890</span>
<span class="x">  bob:</span>
<span class="x">    name: Bob Bananarama</span>
<span class="x">    telephone: 987-654-3210</span>
<span class="x">tasks:</span>
<span class="x">  - name: Print phone records</span>
<span class="x">    debug: msg=&quot;User </span><span class="cp">{{</span> <span class="nv">item.key</span> <span class="cp">}}</span><span class="x"> is </span><span class="cp">{{</span> <span class="nv">item.value.name</span> <span class="cp">}}</span><span class="x"> (</span><span class="cp">{{</span> <span class="nv">item.value.telephone</span> <span class="cp">}}</span><span class="x">)&quot;</span>
<span class="x">    with_dict: &quot;</span><span class="cp">{{</span> <span class="nv">users</span> <span class="cp">}}</span><span class="x">&quot;</span>
</pre></div>


<ul>
<li>nested</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">- name: give users access to multiple databases</span>
<span class="x">  mysql_user: name=</span><span class="cp">{{</span> <span class="nv">item</span><span class="o">[</span><span class="m">0</span><span class="o">]</span> <span class="cp">}}</span><span class="x"> priv=</span><span class="cp">{{</span> <span class="nv">item</span><span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="cp">}}</span><span class="x">.*:ALL append_privs=yes password=foo</span>
<span class="x">  with_nested:</span>
<span class="x">    - [ &#39;alice&#39;, &#39;bob&#39; ]</span>
<span class="x">    - [ &#39;clientdb&#39;, &#39;employeedb&#39;, &#39;providerdb&#39; ]</span>
</pre></div>


<ul>
<li>new in 2.0:include yml:</li>
</ul>
<div class="highlight"><pre><span></span><span class="x"># main.yml</span>
<span class="x">- include: inner.yml</span>
<span class="x">  with_items:</span>
<span class="x">    - 1</span>
<span class="x">    - 2</span>
<span class="x">    - 3</span>

<span class="x"># inner.yml</span>
<span class="x">- set_fact:</span>
<span class="x">    outer_item: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>

<span class="x">- debug:</span>
<span class="x">    msg: &quot;outer item=</span><span class="cp">{{</span> <span class="nv">outer_item</span> <span class="cp">}}</span><span class="x"> inner item=</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">  with_items:</span>
<span class="x">    - a</span>
<span class="x">    - b</span>
<span class="x">    - c</span>
</pre></div>


<ul>
<li>new in 2.2:循环间隔时间</li>
</ul>
<div class="highlight"><pre><span></span><span class="x"># main.yml</span>
<span class="x">- name: create servers, pause 3s before creating next</span>
<span class="x">  digital_ocean:</span>
<span class="x">    name: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">    state: present</span>
<span class="x">  with_items:</span>
<span class="x">    - server1</span>
<span class="x">    - server2</span>
<span class="x">  loop_control:</span>
<span class="x">    pause: 3</span>
</pre></div>


<ul>
<li>new in 2.2:只显示部分到stdout</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">- name: create servers</span>
<span class="x">  digital_ocean:</span>
<span class="x">    name: &quot;</span><span class="cp">{{</span> <span class="nv">item.name</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">    state: present</span>
<span class="x">  with_items:</span>
<span class="x">    - name: server1</span>
<span class="x">      disks: 3gb</span>
<span class="x">      ram: 15Gb</span>
<span class="x">      network:</span>
<span class="x">        nic01: 100Gb</span>
<span class="x">        nic02: 10Gb</span>
<span class="x">        ...</span>
<span class="x">  loop_control:</span>
<span class="x">    label: &quot;</span><span class="cp">{{</span><span class="nv">item.name</span><span class="cp">}}</span><span class="x">&quot; </span>
</pre></div>


<ul>
<li>loop_control :new in 2.1 </li>
</ul>
<div class="highlight"><pre><span></span><span class="x"># main.yml</span>
<span class="x">- include: inner.yml</span>
<span class="x">  with_items:</span>
<span class="x">    - 1</span>
<span class="x">    - 2</span>
<span class="x">    - 3</span>
<span class="x">  loop_control:</span>
<span class="x">    loop_var: outer_item</span>

<span class="x"># inner.yml</span>
<span class="x">- debug:</span>
<span class="x">    msg: &quot;outer item=</span><span class="cp">{{</span> <span class="nv">outer_item</span> <span class="cp">}}</span><span class="x"> inner item=</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">  with_items:</span>
<span class="x">    - a</span>
<span class="x">    - b</span>
<span class="x">    - c</span>
</pre></div>


<ul>
<li>with_inventory_hostnames :new in 2.1</li>
</ul>
<div class="highlight"><pre><span></span><span class="x"># show all the hosts in the inventory</span>
<span class="x">- debug:</span>
<span class="x">    msg: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">  with_inventory_hostnames:</span>
<span class="x">    - all</span>

<span class="x"># show all the hosts matching the pattern, ie all but the group www</span>
<span class="x">- debug:</span>
<span class="x">    msg: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">  with_inventory_hostnames:</span>
<span class="x">    - all:!www</span>
</pre></div>


<ul>
<li>Flattening A List</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">---</span>
<span class="x">- hosts: all</span>
<span class="x">  vars:</span>
<span class="x">    packages_base:</span>
<span class="x">      - [ &#39;foo-package&#39;, &#39;bar-package&#39; ]</span>
<span class="x">    packages_apps:</span>
<span class="x">      - [ [&#39;one-package&#39;, &#39;two-package&#39; ]]</span>
<span class="x">      - [ [&#39;red-package&#39;], [&#39;blue-package&#39;]]</span>
<span class="x">  tasks:</span>

<span class="x">    - name: flattened loop demo</span>
<span class="x">      debug:</span>
<span class="x">        msg: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">      with_flattened:</span>
<span class="x">         - &quot;</span><span class="cp">{{</span> <span class="nv">packages_base</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">         - &quot;</span><span class="cp">{{</span> <span class="nv">packages_apps</span> <span class="cp">}}</span><span class="x">&quot;</span>
</pre></div>


<ul>
<li>ini 文件</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">The ini plugin can use regexp to retrieve a set of keys. As a consequence, we can loop over this set. Here is the ini file we’ll use:</span>

<span class="x">[section1]</span>
<span class="x">value1=section1/value1</span>
<span class="x">value2=section1/value2</span>

<span class="x">[section2]</span>
<span class="x">value1=section2/value1</span>
<span class="x">value2=section2/value2</span>
<span class="x">Here is an example of using with_ini:</span>

<span class="x">- debug:</span>
<span class="x">    msg: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">  with_ini:</span>
<span class="x">    - value[1-2]</span>
<span class="x">    - section: section1</span>
<span class="x">    - file: &quot;lookup.ini&quot;</span>
<span class="x">    - re: true</span>
</pre></div>


<ul>
<li>with_first_found</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">- name: INTERFACES | Create Ansible header for /etc/network/interfaces</span>
<span class="x">  template:</span>
<span class="x">    src: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">    dest: &quot;/etc/foo.conf&quot;</span>
<span class="x">  with_first_found:</span>
<span class="x">    - &quot;</span><span class="cp">{{</span> <span class="nv">ansible_virtualization_type</span> <span class="cp">}}</span><span class="x">_foo.conf&quot;</span>
<span class="x">    - &quot;default_foo.conf&quot;</span>
<span class="x">####################3</span>
<span class="x">- name: some configuration template</span>
<span class="x">  template:</span>
<span class="x">    src: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">    dest: &quot;/etc/file.cfg&quot;</span>
<span class="x">    mode: 0444</span>
<span class="x">    owner: &quot;root&quot;</span>
<span class="x">    group: &quot;root&quot;</span>
<span class="x">  with_first_found:</span>
<span class="x">    - files:</span>
<span class="x">       - &quot;</span><span class="cp">{{</span> <span class="nv">inventory_hostname</span> <span class="cp">}}</span><span class="x">/etc/file.cfg&quot;</span>
<span class="x">      paths:</span>
<span class="x">       - ../../../templates.overwrites</span>
<span class="x">       - ../../../templates</span>
<span class="x">    - files:</span>
<span class="x">        - etc/file.cfg</span>
<span class="x">      paths:</span>
<span class="x">        - templates</span>
</pre></div>


<ul>
<li>with_sequence</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">---</span>
<span class="x">- hosts: all</span>

<span class="x">  tasks:</span>

<span class="x">    # create groups</span>
<span class="x">    - group:</span>
<span class="x">        name: &quot;evens&quot;</span>
<span class="x">        state: present</span>
<span class="x">    - group:</span>
<span class="x">        name: &quot;odds&quot;</span>
<span class="x">        state: present</span>

<span class="x">    # create some test users</span>
<span class="x">    - user:</span>
<span class="x">        name: &quot;</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        state: present</span>
<span class="x">        groups: &quot;evens&quot;</span>
<span class="x">      with_sequence:</span>
<span class="x">        - start: 0</span>
<span class="x">        - end: 32</span>
<span class="x">        - format: testuser%02x</span>

<span class="x">    # create a series of directories with even numbers for some reason</span>
<span class="x">    - file:</span>
<span class="x">        dest: &quot;/var/stuff/</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        state: directory</span>
<span class="x">      with_sequence:</span>
<span class="x">        - start: 4</span>
<span class="x">        - end: 16</span>
<span class="x">        - stride: 2</span>

<span class="x">    # a simpler way to use the sequence plugin</span>
<span class="x">    # create 4 groups</span>
<span class="x">    - group:</span>
<span class="x">        name: &quot;group</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        state: present</span>
<span class="x">      with_sequence:</span>
<span class="x">        count: 4</span>
</pre></div>


<ul>
<li>with_together</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">#And you want the set of ‘(a, 1)’ and ‘(b, 2)’ and so on. Use ‘with_together’ to get this:</span>

<span class="x">tasks:</span>
<span class="x">    - debug:</span>
<span class="x">        msg: &quot;</span><span class="cp">{{</span> <span class="nv">item.0</span> <span class="cp">}}</span><span class="x"> and </span><span class="cp">{{</span> <span class="nv">item.1</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">      with_together:</span>
<span class="x">        - &quot;</span><span class="cp">{{</span> <span class="nv">alpha</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        - &quot;</span><span class="cp">{{</span> <span class="nv">numbers</span> <span class="cp">}}</span><span class="x">&quot;</span>
</pre></div>


<ul>
<li>with_nested :后面接iteration,如果直接是dict()会只取keys();但如果是[dict()],没问题</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">- name: here, &#39;users&#39; contains the above list of employees</span>
<span class="x">  mysql_user:</span>
<span class="x">    name: &quot;</span><span class="cp">{{</span> <span class="nv">item</span><span class="o">[</span><span class="m">0</span><span class="o">]</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">    priv: &quot;</span><span class="cp">{{</span> <span class="nv">item</span><span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="cp">}}</span><span class="x">.*:ALL&quot;</span>
<span class="x">    append_privs: yes</span>
<span class="x">    password: &quot;foo&quot;</span>
<span class="x">  with_nested:</span>
<span class="x">    - &quot;</span><span class="cp">{{</span> <span class="nv">users</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">    - [ &#39;clientdb&#39;, &#39;employeedb&#39;, &#39;providerdb&#39; ]</span>
</pre></div>


<ul>
<li>遍历数据并行集合</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">---</span>
<span class="x">- hosts: webservers</span>
<span class="x">  remote_user: root</span>
<span class="x">  vars:</span>
<span class="x">    alpha: [ &#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;]</span>
<span class="x">    numbers: [ 1,2,3,4 ]</span>
<span class="x">  tasks:</span>
<span class="x">    - debug: msg=&quot;</span><span class="cp">{{</span> <span class="nv">item.0</span> <span class="cp">}}</span><span class="x"> and </span><span class="cp">{{</span> <span class="nv">item.1</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">      with_together:</span>
<span class="x">         - &quot;</span><span class="cp">{{</span> <span class="nv">alpha</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">         - &quot;</span><span class="cp">{{</span> <span class="nv">numbers</span> <span class="cp">}}</span><span class="x">&quot;</span>
</pre></div>


<ul>
<li>with_fileglob匹配单个目录下所有文件</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">---</span>
<span class="x">- hosts: all</span>

<span class="x">  tasks:</span>

<span class="x">    # first ensure our target directory exists</span>
<span class="x">    - file: dest=/etc/fooapp state=directory</span>

<span class="x">    # copy each file over that matches the given pattern</span>
<span class="x">    - copy: src=</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> dest=/etc/fooapp/ owner=root mode=600</span>
<span class="x">      with_fileglob:</span>
<span class="x">        - /playbooks/files/fooapp/*</span>
</pre></div>


<ul>
<li>也可以遍历嵌套的子列表：
变量文件 ：</li>
</ul>
<div class="highlight"><pre><span></span>users:
  - name: alice
    authorized:
      - /tmp/alice/onekey.pub
      - /tmp/alice/twokey.pub
    mysql:
        password: mysql-password
        hosts:
          - &quot;%&quot;
          - &quot;127.0.0.1&quot;
          - &quot;::1&quot;
          - &quot;localhost&quot;
        privs:
          - &quot;*.*:SELECT&quot;
          - &quot;DB1.*:ALL&quot;
  - name: bob
    authorized:
      - /tmp/bob/id_rsa.pub
    mysql:
        password: other-mysql-password
        hosts:
          - &quot;db1&quot;
        privs:
          - &quot;*.*:SELECT&quot;
          - &quot;DB2.*:ALL&quot;
</pre></div>


<div class="highlight"><pre><span></span><span class="x">- name: Setup MySQL users</span>
<span class="x">  mysql_user: name=</span><span class="cp">{{</span> <span class="nv">item.0.user</span> <span class="cp">}}</span><span class="x"> password=</span><span class="cp">{{</span> <span class="nv">item.0.mysql.password</span> <span class="cp">}}</span><span class="x"> host=</span><span class="cp">{{</span> <span class="nv">item.1</span> <span class="cp">}}</span><span class="x"> priv=</span><span class="cp">{{</span> <span class="nv">item.0.mysql.privs</span> <span class="o">|</span> <span class="nf">join</span><span class="o">(</span><span class="s1">&#39;/&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">  with_subelements:</span>
<span class="x">    - users</span>
<span class="x">    - mysql.hosts  #must be string</span>
</pre></div>


<ul>
<li>any_errors_fatal :The any_errors_fatal play option will mark all hosts as failed if any fails, causing an immediate abort:</li>
</ul>
<div class="highlight"><pre><span></span>- hosts: somehosts  
  any_errors_fatal: true  
  roles:    - myrole
</pre></div>


<ul>
<li>with_dict</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">---</span>
<span class="x">- hosts: all</span>
<span class="x">  vars:</span>
<span class="x">    users:</span>
<span class="x">      alice:</span>
<span class="x">        name: Alice Appleworth</span>
<span class="x">        telephone: 123-456-7890</span>
<span class="x">      bob:</span>
<span class="x">        name: Bob Bananarama</span>
<span class="x">        telephone: 987-654-3210</span>
<span class="x">  tasks:</span>
<span class="x">    - name: Print phone records</span>
<span class="x">      debug: msg=&quot;User </span><span class="cp">{{</span> <span class="nv">item.key</span> <span class="cp">}}</span><span class="x"> is </span><span class="cp">{{</span> <span class="nv">item.value.name</span> <span class="cp">}}</span><span class="x"> (</span><span class="cp">{{</span> <span class="nv">item.value.telephone</span> <span class="cp">}}</span><span class="x">)&quot;</span>
<span class="x">      with_dict: &quot;</span><span class="cp">{{</span> <span class="nv">users</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">#不能使用</span>
<span class="x">#with_dict:</span>
<span class="x">#  - aaa</span>
</pre></div>


<ul>
<li>register 配合with_items</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">- name: registered variable usage as a with_items list</span>
<span class="x">  hosts: all</span>

<span class="x">  tasks:</span>

<span class="x">      - name: retrieve the list of home directories</span>
<span class="x">        command: ls /home</span>
<span class="x">        register: home_dirs</span>

<span class="x">      - name: add home dirs to the backup spooler</span>
<span class="x">        file: path=/mnt/bkspool/</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> src=/home/</span><span class="cp">{{</span> <span class="nv">item</span> <span class="cp">}}</span><span class="x"> state=link</span>
<span class="x">        with_items: &quot;</span><span class="cp">{{</span> <span class="nv">home_dirs.stdout_lines</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        # same as with_items: &quot;</span><span class="cp">{{</span> <span class="nv">home_dirs.stdout.split</span><span class="o">()</span> <span class="cp">}}</span><span class="x">&quot;</span>
</pre></div>
        </div><!-- /.entry-content -->

</article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                        </ul>
                </div><!-- /.blogroll -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://smashingmagazine.com">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>